name: weekly-security-audit

on:
  workflow_dispatch:
  schedule:
    # æ¯Žé€±æœˆæ›œ 09:00 JST = 00:00 UTC
    - cron: "0 0 * * 1"

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: ç›£è¦–ç”¨ãƒªãƒã‚¸ãƒˆãƒªã‚’checkout
        uses: actions/checkout@v4

      - name: Node.js ã‚’æº–å‚™
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Python ã‚’æº–å‚™
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: corepack ã‚’æœ‰åŠ¹åŒ–ï¼ˆyarn/pnpmã®ãŸã‚ï¼‰
        run: corepack enable

      - name: pnpm ã‚’å…¥ã‚Œã‚‹ï¼ˆpnpmãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹ãŸã‚ï¼‰
        run: npm i -g pnpm

      - name: å„ãƒªãƒã‚¸ãƒˆãƒªã‚’ç›£æŸ»ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        env:
          TOKEN: ${{ secrets.AUDIT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          : > report.txt

          mkdir -p work

          while IFS= read -r REPO; do
            [ -z "$REPO" ] && continue
            echo "==> $REPO"

            rm -rf work/repo work/out
            mkdir -p work/out

            # ä»–repoã‚’cloneï¼ˆTOKENãŒéµï¼‰
            git clone --depth 1 "https://x-access-token:${TOKEN}@github.com/${REPO}.git" work/repo

            # auditå®Ÿè¡Œï¼ˆJSONã‚’ work/out/audit.json ã«å‡ºã™ï¼‰
            bash scripts/audit_repo.sh work/repo work/out

            # JSONãŒã‚ã‚‹æ™‚ã ã‘è§£æžã—ã¦è¿½è¨˜ï¼ˆæ—¥æœ¬èªžãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
            if [ -f work/out/audit.json ]; then
              REPO="$REPO" python3 scripts/parse_audit.py work/out/audit.json >> report.txt
            else
              echo "âš ï¸ $REPO: audit.json ãŒä½œã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆlockfileç„¡ã—ç­‰ã®å¯èƒ½æ€§ï¼‰" >> report.txt
            fi

            echo "" >> report.txt
          done < repos.txt

      - name: Slack ã«é€šçŸ¥
        if: always()
        env:
          SLACK: ${{ secrets.SLACK_WEBHOOK_URL }}
        shell: bash
        run: |
          set -euo pipefail
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          BODY="$(head -n 200 report.txt | sed 's/"/\\"/g')"
          payload=$(printf '{"text":"%s"}' "$(echo -e "ðŸ›¡ï¸ ä¾å­˜é–¢ä¿‚ã®å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆä»Šé€±åˆ†ï¼‰\nå®Ÿè¡Œãƒ­ã‚°: ${RUN_URL}\n\n${BODY}")")
          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK" >/dev/null
